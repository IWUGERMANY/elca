!function(window,$,undefined){var jBlibs=window.jBlibs=window.jBlibs||{};jBlibs.App={rootUrl:null,options:{debug:!1,controllers:{},updateHashUrlCssClass:null},init:function(opts){var me=this;return"debug"in opts&&(this.options.debug=opts.debug),"updateHashUrlCssClass"in opts&&(this.options.updateHashUrlCssClass=opts.updateHashUrlCssClass),this._globalInitialize(),$.isFunction(opts.initialize)&&opts.initialize(this),$.each(opts.controllers,function(name){var ctrl=me.options.controllers[name]=$.extend(!0,{},me._controller,this);ctrl._initialize(name)&&ctrl._prepare($("body"))}),$.extend(!0,this.options.controllers,opts.controllers),this},_globalInitialize:function(){return!this._isInitialized&&(this.rootUrl=window.location.protocol+"//"+window.location.hostname,""!==window.location.port&&80!==window.location.port&&443!==window.location.port&&(this.rootUrl+=":"+window.location.port),this._bindHashChange(),this._ajaxSetup(),this._isInitialized=!0,!0)},_controller:{debug:!1,_ctrlName:null,_initialize:function(ctrlName){return!!this._isInitialized||!!this._urlMatches()&&(this._ctrlName=ctrlName,(this.debug||jBlibs.App.options.debug)&&window.console.log("Initialize "+this._ctrlName),$.isFunction(this.initialize)&&this.initialize.apply(this),this._isInitialized=!0,!0)},_prepare:function($view){var me=this;$view.attr("id");if(this._urlMatches())return $.each(this.views,function(selector,fn){var $viewContext,$context;if($view.is(selector)&&($viewContext=$view,(me.debug||jBlibs.App.options.debug)&&window.console.log("Prepare "+me._ctrlName+" controller view "+selector+" within context",$viewContext,fn),$viewContext.length&&!$viewContext.is(":empty")))switch(me.controls&&$.isPlainObject(me.controls)&&($context=$viewContext,$.each(me.controls,function(selector,events){$.isPlainObject(events)?$.each(events,function(eventName,config){$(selector,$context).off(eventName).on(eventName,function(e){var url,successFn,errorFn,data;return"object"==typeof config?(config.target&&(url=me._getTargetUrl(config.target,this,e)),config.success&&(successFn=config.success),config.error&&(errorFn=config.error),config.data&&(data=config.data)):url=me._getTargetUrl(config,this,e),url&&(jBlibs.App.options.updateHashUrlCssClass&&$(this).hasClass(jBlibs.App.options.updateHashUrlCssClass)&&jBlibs.App.updateHashUrl(url,!0),jBlibs.App.query(url,data,{success:successFn,error:errorFn})),e.preventDefault(),!1})}):$.isFunction(events)&&events.call(me,$(selector,$context))})),typeof fn){case"function":fn.call(me,$viewContext);break;case"object":Array.isArray(fn)&&$.each(fn,function(i,fnName){$.isFunction(me[fnName])&&me[fnName].call(me,$viewContext)});break;case"string":$.isFunction(me[fn])&&me[fn].call(me,$viewContext)}}),this},_getTargetUrl:function(target,elt,event){var url;switch(typeof target){case"function":url=target.call(elt,event,this);break;case"string":url=$.isFunction(this[target])?this[target].call(elt,event,this):$(elt).attr(target)}return url},_urlMatches:function(){if(!this.urls)return!0;var url=jBlibs.App.getHashUrl()||document.URL.replace(jBlibs.App.rootUrl,""),matches=this.urls,isAMatch=!1;switch(typeof matches){case"object":if(matches.test){isAMatch=matches.test(url);break}case"array":$.each(matches,function(i,match){if(isAMatch=match===url)return!1});break;case"number":case"string":isAMatch=String(matches)===url}return isAMatch}},_ajaxSetup:function(){var me=this;$(document).ajaxSend(function(e,xhr,settings){me._startLoading(),$.each(me.options.controllers,function(ctrlName){this.onLoad&&$.isFunction(this.onLoad)&&this.onLoad.call(this,e,xhr,settings)})}),$(document).ajaxSuccess(function(e,xhr,settings){me._checkHeader(xhr);var response=$.parseJSON(xhr.responseText);me._replaceView(response),$.each(me.options.controllers,function(ctrlName){this.onSuccess&&$.isFunction(this.onSuccess)&&this.onSuccess.call(this,e,xhr,settings,response)}),$.isFunction(settings.extSuccess)&&settings.extSuccess.call(me,response,xhr.statusText,xhr)}),$(document).ajaxError(function(e,xhr,settings,response){$.each(me.options.controllers,function(ctrlName){this.onError&&$.isFunction(this.onError)&&this.onError.call(this,e,xhr,settings,response)}),$.isFunction(settings.extError)&&settings.extError.call(me,xhr,xhr.statusText)}),$(document).ajaxComplete(function(e,xhr,settings){me._stopLoading(),$.isFunction(settings.extComplete)&&settings.extComplete(me,xhr,xhr.statusText)})},query:function(href,data,opts){return opts||(opts={}),$.ajax({url:href,data:data,type:opts.httpMethod||"GET",extSuccess:opts.success,extError:opts.error,extComplete:opts.complete})},updateHashUrl:function(href,justUpdate,replace){if(href!=window.location.href){var url=$.url(href),hash="!";if(url.attr("path"))hash+=url.attr("path"),url.attr("query")&&(hash+="?"+url.attr("query"));else{var currentUrl=$.url(this.getHashUrl());if(hash+=currentUrl.attr("path"),url.attr("query")){var currentParams=currentUrl.attr("query")?currentUrl.param():{},newParams=url.param();$.extend(currentParams,newParams),hash+="?"+$.param(currentParams)}}jBlibs.App.disableHashchange=justUpdate,replace?window.location.replace("#"+hash):window.location.hash=hash}},getHashUrl:function(){return"!"===window.location.hash.charAt(1)&&window.location.hash.replace("#!","")},scrollTo:function(element,margin,force){var position=$(element).offset();margin||(margin=0),(force||$(window).scrollTop()>position.top+$(element).height())&&(this.debug&&console.log("scroll to "+Math.max(position.top-margin,0)),window.scrollTo(position.left,Math.max(position.top-margin,0)))},_bindHashChange:function(){var me=this;$(window).bind("hashchange",function(e){me.disableHashchange||me.query(me.getHashUrl()),me.disableHashchange=!1})},_checkHeader:function(xhr,response){if(!xhr.getResponseHeader("X-Redirect"))return xhr.getResponseHeader("X-Reload")?window.location.reload():xhr.getResponseHeader("X-Load-Hash")?jBlibs.App.updateHashUrl(xhr.getResponseHeader("X-Load-Hash"),!1):xhr.getResponseHeader("X-Update-Hash")?jBlibs.App.updateHashUrl(xhr.getResponseHeader("X-Update-Hash"),!0):xhr.getResponseHeader("X-Replace-Hash")?jBlibs.App.updateHashUrl(xhr.getResponseHeader("X-Replace-Hash"),!0,!0):xhr.getResponseHeader("X-Reload-Hash")?jBlibs.App.query(jBlibs.App.getHashUrl()):xhr.getResponseHeader("X-Auth")?window.location.reload():void 0;window.location.href.replace(new RegExp(this.rootUrl),"")!=xhr.getResponseHeader("X-Redirect")?window.location.replace(xhr.getResponseHeader("X-Redirect")):window.location.reload()},_replaceView:function(response){if(response&&"object"==typeof response){var self=this;for(var name in response)switch(name){case"redirect":window.location.replace(response[name]);break;case"noAccess":var redirectTo=response[name];"string"==typeof redirectTo&&redirectTo.match(/^\//)||(redirectTo="/"),setTimeout(function(){window.location.replace(redirectTo)},2e3);break;case"run":eval(response[name]);break;case"title":break;default:var $response=$(response[name]);$view=$response.filter(function(){return 1===this.nodeType}).eq(0);var wrapperId=$view.attr("id");wrapperId&&($("#"+wrapperId).replaceWith($view),$.each(self.options.controllers,function(ctrlName){this._initialize(ctrlName)&&this._prepare($view,name)}))}return this}},_loadingTimer:null,_startLoading:function(){var self=this;null==this._loadingTimer&&(this._loadingTimer=window.setTimeout(function(){$("body").addClass("loading"),self._loadingTimer=null},500))},_stopLoading:function(){$("body").removeClass("loading"),window.clearTimeout(this._loadingTimer),this._loadingTimer=null}}}(window,jQuery),$(window).load(function(){jBlibs.App.init({debug:!1,updateHashUrlCssClass:"page",elca:null,initialize:function(){window.onunload=window.onbeforeunload=function(){},Cookies.json=!0,$.extend($.expr[":"],{internal:function(obj){return!/^.+?:\/\//.test($(obj).attr("href"))}}),$.fn.extend({highlightMissingTranslation:function(){return this.each(function(){if(3==this.nodeType)this.textContent=this.textContent.replace(/\_\_\*\*/,""),this.textContent=this.textContent.replace(/\*\*\_\_/,""),$(this).wrap('<span class="mi-tr"/>');else switch(this.tagName){case"INPUT":$(this).attr("value",$(this).attr("value").replace(/\*\*\_\_/,"")).attr("value",$(this).attr("value").replace(/\_\_\*\*/,"")),$(this).addClass("mi-tr");break;case"OPTION":var clean;clean=(clean=$(this).text().replace(/\*\*\_\_/,"")).replace(/\_\_\*\*/,""),$(this).html(clean),$(this).addClass("mi-tr"),$(this).closest("select").addClass("mi-tr");break;default:$(this).attr("title")?$(this).attr("title",$(this).attr("title").replace(/\*\*\_\_/,"")).attr("title",$(this).attr("title").replace(/\_\_\*\*/,"")).addClass("mi-tr"):$(this).attr("alt")?$(this).attr("alt",$(this).attr("alt").replace(/\*\*\_\_/,"")).attr("alt",$(this).attr("alt").replace(/\_\_\*\*/,"")).addClass("mi-tr"):$(this).attr("label")?$(this).attr("label",$(this).attr("label").replace(/\*\*\_\_/,"")).attr("label",$(this).attr("label").replace(/\_\_\*\*/,"")).addClass("mi-tr"):console.log("could not highlight missing translation for ["+this.tagName+"]")}})},toggleSection:function(elementToToggle,cookieName,clicked,callback){var key=elementToToggle.attr("id");if(key){if(Cookies&&!Cookies.get(cookieName)&&Cookies.set(cookieName,{},{path:"/"}),Cookies&&void 0===Cookies.get(cookieName)[key]){var initialValue=Cookies.get(cookieName);initialValue[key]=elementToToggle.is(":visible"),Cookies.set(cookieName,initialValue,{path:"/"})}var cookieValue=Cookies.get(cookieName);clicked?(clicked.preventDefault(),this.toggleClass("open"),elementToToggle.toggle(),cookieValue[key]=!cookieValue[key],Cookies.set(cookieName,cookieValue,{path:"/"})):cookieValue[key]?(this.addClass("open"),elementToToggle.show()):(this.removeClass("open"),elementToToggle.hide()),callback&&callback(this.hasClass("open"))}else console.log("Toggle section failed! Toggler needs id")}}),$.fn.atEndOfViewport=function(callback,interval){return this.each(function(){var $this=$(this),t=interval||200;if($this.visible())callback.call($this);else var timer=window.setInterval(function(){$this.visible()&&(window.clearInterval(timer),$this.closest("html").length&&callback.call($this))},t)})}},controllers:{default:{debug:!1,initialize:function(){jBlibs.App.elca=this,jBlibs.App.query(jBlibs.App.getHashUrl()||document.URL,{_isBaseReq:!0}),$("body.hl-mi-tr *").contents().filter(function(){return 3===this.nodeType&&/\_\_\*\*(.+?)\*\*\_\_/m.test(this.textContent)}).highlightMissingTranslation()},onLoad:function(e,xhr,ajaxOpts){var hashUrl=jBlibs.App.getHashUrl();hashUrl&&xhr.setRequestHeader("X-Hash-Url",hashUrl)},onSuccess:function(e,xhr,settings,response){if("object"==typeof response){var projectId,result=document.URL.match(/\/projects\/(\d+)/);result&&(projectId=result[1],response.projectId!=projectId&&null!=response.projectId&&null!=projectId&&confirm("Die aktuelle Ansicht ist nicht mehr aktuell! Möglicherweise arbeiten Sie mit mehreren Tabs und in unterschiedlichen Projekten. Wollen Sie zum aktuellen Projekt wechseln?")&&(window.location.href="/projects/"+response.projectId+"/"))}},onError:function(xhr,status,response){},controls:{"a:not(.no-xhr):not([rel])":{click:function(e){return!($(this).hasClass("confirm")&&$(this).closest("form.changed").length&&!confirm("Durch diese Aktionen gehen ungespeicherte Änderungen verloren. Möchten Sie wirklich fortfahren?"))&&$(this).attr("href")}},"select.lc-select,select.db-select":{change:function(e){return $(this).data("url")+"&"+$(this).serialize()}}},views:{"#content,#tabContent,#contentHead":"prepareContent","#elcaSheetsContainer,ul.pageable,ul.elements":["prepareContent","preparePageable","prepareElementImages","prepareFilterTags"],"#content.elca-filter-sheets":["prepareFilterList","preparePageable","prepareElementImages","prepareFilterTags"],"#tabContent.elements,#tabContent.project-elements":["prepareElement","prepareLifeTimeInput"],"#tabContent.tab-lca,div.process-assignment,div.process-group":"prepareLcaToggle","#content.ElcaProcessesCtrl .tab-general":"prepareProcessConfigGeneral","div.process-assignment,div.process-group":"prepareContent","div.element-section,#element-layers,#element-components,div.element-component,div.element":["prepareElementComponents","prepareLifeTimeInput"],"#content.elements.overview":"prepareElementOverview","div.ElcaHtmlProcessConfigSelectorLink-section.refProcessConfigId":["prepareContent","prepareAdminBenchmarkVersion"],"#tabContent.elca-admin-benchmark-version":"prepareAdminBenchmarkVersion","#osit":"highlightMissingTranslations","#msgBox":null,"#elca-modal-content":"prepareContent","#conversions":null,"#projectNavigation":null,"#content.process-databases":"initTableScroll","#content.process-sanity":"prepareProcessSanity","#processSanityTable":null,"#tabContent.tab-general,#content.svg-patterns,#content.svg-pattern-assignments,ul.svg-pattern-assignments-process-configs":"prepareSvgPatternSelect","ul.svg-pattern-assignments-process-configs":"prepareContent","#content.svg-pattern-assignments":"preparePatternAssignments","#content.project-final-energy":"prepareFinalEnergy","#content.report.report-assets":"prepareElementImages","#content.report.report-effects-elements":"prepareElementImages","#content.report.report-effects":"prepareDetailInfoToggle","#content.project.general-default,#content.project.general-create":"prepareProjectGeneralView","#content.project-transports,ul.transport-means":"prepareProjectTransports","ul.transport-means":"prepareContent","div.ElcaHtmlProcessConfigSelectorLink-section.assistant":"prepareContent","div.ElcaHtmlElementSelectorLink-section.assistant":"prepareContent","#templateElement":["prepareContent","prepareElementImages"],"#tabContent.tab-window-assistant":"prepareWindowAssistant","#tabContent.tab-dormer-assistant":"prepareWindowAssistant","#tabContent.tab-staircase-assistant":"prepareStaircaseAssistant","#tabContent.pillar-assistants":"preparePillarAssistant","#subscribeForm":"prepareSubscribeForm","#forgotForm":"prepareForgotForm","#content.project-search-and-replace-processes":"prepareSearchAndReplace","#content.elca-project-life-cycle-usage,#tabContent.tab-lca.elca-admin-benchmark-version":"prepareLifeCycleUsageCheckboxes","body.projects":"prepareContent","#projectProcessConfigSanity":"prepareContent","#content.replace-components, #content.replace-elements":["prepareReplaceElementComponents","prepareElementImages"],"#content.project-csv-import.preview":"prepareElementImages","#content.project-csv-import.preview.ifc":"prepareContent"},prepareSearchAndReplace:function($context){this.prepareContent($context),$(".header a.all",$context).on("click",function(e){return e.preventDefault(),$('input[type="checkbox"]',$(this).closest("fieldset")).attr("checked","checked").prop("checked",!0),!1}),$(".header a.invert",$context).on("click",function(e){return e.preventDefault(),$('input[type="checkbox"]',$(this).closest("fieldset")).each(function(){$(this).is(":checked")?$(this).removeAttr("checked").prop("checked",!1):$(this).attr("checked","checked").prop("checked",!0)}),!1})},prepareReplaceElementComponents:function($context){var $buttons=$context.find(".buttons"),$checkboxes=$context.find("input[type=checkbox]");function checkVisibility(){$checkboxes.is(":checked")?$buttons.show():$buttons.hide()}checkVisibility(),$checkboxes.on("change",function(){checkVisibility()})},prepareLifeCycleUsageCheckboxes:function($context){this.connectLifeCycleUsageCheckboxes($context,"construction"),this.connectLifeCycleUsageCheckboxes($context,"maintenance")},connectLifeCycleUsageCheckboxes:function($context,type){var $a13=$('input[name="'+type+'[A1-3]"]',$context),$a1=$('input[name="'+type+'[A1]"]',$context),$a2=$('input[name="'+type+'[A2]"]',$context),$a3=$('input[name="'+type+'[A3]"]',$context),$d=$('input[name$="[D]"]',$context),onChangeSingleA=function(e){$(e.target).is(":checked")?$a1.is(":checked")&&$a2.is(":checked")&&$a3.is(":checked")?($a13.prop("checked",!0),$a13.prop("disabled",!1),$a1.prop("disabled",!0),$a2.prop("disabled",!0),$a3.prop("disabled",!0)):$a13.prop("disabled",!0):$a1.is(":checked")||$a2.is(":checked")||$a3.is(":checked")?$a13.prop("checked",!1):$a13.prop("disabled",!1)};$a13.on("change",function(){$a1.prop("checked",$(this).prop("checked")),$a2.prop("checked",$(this).prop("checked")),$a3.prop("checked",$(this).prop("checked")),$a1.prop("disabled",$(this).prop("checked")),$a2.prop("disabled",$(this).prop("checked")),$a3.prop("disabled",$(this).prop("checked"))}),$a1.on("change",onChangeSingleA),$a2.on("change",onChangeSingleA),$a3.on("change",onChangeSingleA),$d.on("change",function(e){$d.filter(":checked").length>0?$("#nonComplianceNotice").removeClass("hidden"):$("#nonComplianceNotice").addClass("hidden")})},prepareSubscribeForm:function($context){if(this.prepareContent($context),!$(".elca-login.show-subscribe-form").length){var startWidth=$(".disclaimer").width();$(".login-wrapper").css({width:250,paddingLeft:0,position:"absolute",left:500,top:0}),$(".disclaimer").animate({width:879},{duration:800,easing:"easeInOutExpo",step:function(step){$(".login-wrapper").css({left:500+step-startWidth})},complete:function(){$(".login-wrapper p.login-only, .login-wrapper .login-form-container").hide(),$(".login-wrapper").css({width:600}),$(".subscribe-form-container").show(),$(".disclaimer").animate({width:250},{easing:"easeInOutBack",duration:1e3,step:function(step){$(".login-wrapper").css({left:500+step-startWidth}),step<500&&$(".disclaimer-content-wrapper").css({width:"auto"})},complete:function(){$(".elca-login").addClass("show-subscribe-form")}})}})}},prepareForgotForm:function($context){if(this.prepareContent($context),!$(".elca-login.show-forgot-form").length){var startWidth=$(".disclaimer").width();$(".login-wrapper").css({width:250,paddingLeft:0,position:"absolute",left:500,top:0}),$(".disclaimer").animate({width:879},{duration:800,easing:"easeInOutExpo",step:function(step){$(".login-wrapper").css({left:500+step-startWidth})},complete:function(){$(".login-wrapper p.login-only, .login-wrapper .login-form-container").hide(),$(".login-wrapper").css({width:250}),$(".forgot-form-container").show(),$(".disclaimer").animate({width:startWidth},{easing:"swing",duration:1e3,step:function(step){$(".login-wrapper").css({left:500+step-startWidth})},complete:function(){$(".elca-login").addClass("show-forgot-form")}})}})}},highlightMissingTranslations:function($context){$("body.hl-mi-tr *").not("option").contents().filter(function(){return 3===this.nodeType&&/\_\_\*\*(.+?)\*\*\_\_/m.test(this.textContent)}).highlightMissingTranslation(),$('body.hl-mi-tr input[value*="__**"][value*="**__"]').highlightMissingTranslation(),$("body.hl-mi-tr option, body.hl-mi-tr optgroup").filter(function(){return/\_\_\*\*(.+?)\*\*\_\_/m.test($(this).text())}).highlightMissingTranslation(),$('body.hl-mi-tr *[title*="__**"][title*="**__"]').highlightMissingTranslation()},prepareContent:function($context){this.prepareSheets($context),this.highlightMissingTranslations($context),$("#content.project-csv-import.preview.ifc .ifcdatadelete").on("click",function(){$(this).parent(".element").fadeOut("slow",this.remove)}),$("#languageChooser li a").off("click").on("click",function(e){var extendedUrl,url=$.url(this);if(url.param("origin")){var old=url.attr("source");url=$.url(old.substring(0,old.indexOf("&origin")))}extendedUrl=$.url(url.attr("relative")+"&origin="+$.base64.encode($.url().attr("relative"))),$(this).attr("href",extendedUrl.attr("source"))}),$("input.numeric-input",$context).each(function(){var $numIn=$(this);$numIn.numeric({decimal:$numIn.data("decimal"),precision:$numIn.data("precision"),decimalPlaces:$numIn.data("scale"),negative:$numIn.data("negative")})}),$('input.indeterminate[type="checkbox"]',$context).each(function(){this.indeterminate=!0;var $this=$(this),oldVal=$(this).val();$this.val("indeterminate").change(function(){$this.val(oldVal)})}),$("input:not(.mark-no-change),textarea:not(.mark-no-change),select:not(.mark-no-change)",$context).on("change input",function(e){$(this).closest("form.highlight-changes").length<1||($(this).addClass("changed"),$(this.form).addClass("changed"))}),$(".changed",$context).length&&$(".changed",$context).eq(0).closest("form.highlight-changes").addClass("changed"),$("form input:text",$context).on("keypress",function(e){if(13==(e.charCode||e.keyCode))return e.preventDefault(),!1}),$("form:not(.no-xhr)",$context).each(function(){var $form=$(this),opts={success:function(data){$form.removeClass("changed"),$(".changed",$form).removeClass("changed")}};$form.ajaxForm(opts)}),$(".ElcaHtmlMultiSelectbox-section",$context).each(function(){var $select=$(this),$links=$("span.select-helpers",$select);$select.find("select:disabled").length||$links.click(function(e){e.preventDefault();var rel=$(e.target).attr("rel");switch("A"!=e.target.tagName&&(rel=$(e.target).parent().attr("rel")),rel){case"all":$("option",$select).attr("selected",!0).prop("selected",!0);break;case"invert":$("option",$select).each(function(){$(this).is(":selected")?$(this).removeAttr("selected").prop("selected",!1):$(this).attr("selected","selected").prop("selected",!0)})}return!1})}),$("#section-layers a.show-dimension-icon").click(function(e){e.preventDefault(),$("#section-layers").addClass("show-dimension")}),$(":input","#section-layers .element-component .length").each(function(){1!=$(this).val()&&$("#section-layers").addClass("show-dimension")}),$(":input","#section-layers .element-component .width").each(function(){1!=$(this).val()&&$("#section-layers").addClass("show-dimension")}),$(".select-text",$context).on("click",function(){var range,selection,valueNode=$(".selection-value",this).get(0);window.getSelection&&document.createRange?(selection=window.getSelection(),(range=document.createRange()).selectNodeContents(valueNode),selection.removeAllRanges(),selection.addRange(range)):document.selection&&document.body.createTextRange&&((range=document.body.createTextRange()).moveToElementText(valueNode),range.select())}),$context.is("#content")&&jBlibs.App.scrollTo($context)},prepareSheets:function($context){$('div.elca-sheet:not(".active") div.elca-sheet-content',$context).click(function(e){var $defaultLink=$("div.function-panel a.default",$(this).parent());$defaultLink.hasClass("no-xhr")?window.location.href=$defaultLink.attr("href"):$defaultLink.click()})},prepareSortable:function($context){$("ol.sortable").sortable({handle:"div.drag-handle",axis:"y",opacity:.8,containment:"div.element-section",placeholder:"drag-placeholder",items:"li.sortable-item",update:function(e,ui){var itemIds=[];$("li",this).each(function(){itemIds.push($(this).attr("id"))}),jBlibs.App.query($(this).data("sort-handler-url"),{elementId:$(this).data("element-id"),positions:itemIds,startIndex:$(this).data("start-index")},{httpMethod:"POST"})}})},prepareElement:function($context){this.prepareSortable($context),this.prepareElementSectionToggle($context),this.prepareElementImages($context,!0),this.prepareCompositeElement($context)},prepareCompositeElement:function($context){$("#compositeElementForm",$context).each(function(){var opaqueArea=$('input[name="opaqueArea"]',this).val(),$refreshButton=$('input[name="refreshOpaqueElements"]',this);$refreshButton.hide(),$("#element-composite .quantity input",this).each(function(){if($(this).val()!==opaqueArea)return $refreshButton.show(),!1})})},prepareElementImages:function($context,overlayOnClick){var $images=$(".element-image:not(.embedded)",$context),len=$images.length,$progressElt=$("#progress"),$printButton=$("div.print.button a",$context);len>0?$printButton.fadeTo("fast",.1):window.status="ready_to_print",$images.each(function(i){var $imgContainer=$(this),load=0;if($.browser.msie&&$.browser.version<9)$imgContainer.append('<p class="not-supported">Leider wird die Bauteilgrafik nicht vom Internet Explorer Version 8 oder kleiner unterstützt.</p>');else{var containerId=$imgContainer.data("container-id");containerId||(containerId=$imgContainer.data("element-id")),$imgContainer.is(":empty")&&$imgContainer.append('<div id="element-image-'+containerId+'"></div>'),overlayOnClick&&$imgContainer.off("click").click(function(e){$("div",this).is(":empty")||jBlibs.App.query($imgContainer.data("url"),{elementId:$imgContainer.data("element-id"),w:950,h:700,m:!0})}),window.setTimeout(function(){jBlibs.App.query($imgContainer.data("url"),{elementId:$imgContainer.data("element-id"),w:$imgContainer.innerWidth(),h:$imgContainer.innerHeight(),c:containerId}),len>=1&&(load=(i+1)/len,$progressElt.html("Bauteilgrafiken werden geladen "+Math.round(100*load)+"%"),1===load?($printButton.fadeTo("normal",1),window.setTimeout(function(){$progressElt.fadeOut("fast"),window.status="ready_to_print"},1e3)):$progressElt.fadeIn())},200*i)}})},prepareLifeTimeInput:function($context){$("div.ElcaHtmlLifeTimeInput-section",$context).each(function(){var $el=$(this),$input=$("input.numeric-input",this),$lifeTimeInfoField=$("input[type=text]",this),$radios=$("input[type=radio]",this),values=[];$radios.each(function(){$(this).data("has-text-input")||values.push($(this).attr("value"))}),$radios.on("change",function(e){var value=$(this).val();value!=$input.val()&&($input.val(value),$input.addClass("changed"))}),$lifeTimeInfoField.on("blur",function(e){""!==$(this).val()&&$input.addClass("changed")}),$input.on("focus",function(e){$el.addClass("active")}).on("blur",function(e){window.setTimeout(function(){$el.removeClass("active")},200)}).on("change",function(e){var pos=$.inArray($(this).val(),values),result=-1!==pos?result:values.length;$radios.prop("checked",!1).attr("checked",!1),$radios.eq(result).prop("checked",!0),-1!==pos?$radios.focus():$lifeTimeInfoField.focus()}),$el.hasClass("error")&&$el.addClass("active")}),$(".form-section.isExtant input",$context).change(function(){var $this=$(this),$elementComponent=$this.closest(".element-component"),$lifeTimeDelayElt=$elementComponent.find(".lifeTimeDelay input");$this.is(":checked")?($lifeTimeDelayElt.removeAttr("disabled").removeAttr("readonly").removeClass("read-only"),$elementComponent.addClass("is-extant")):($lifeTimeDelayElt.val(0),$lifeTimeDelayElt.attr("readonly","readonly").attr("disabled","disabled").addClass("read-only"),$elementComponent.removeClass("is-extant"))}),$(".element-component a.show-lifeTimeDelay-icon",$context).click(function(e){e.preventDefault(),$(this).closest(".element-component").addClass("show-lifeTimeDelay")}),$(".element-component .lifeTimeDelay :input",$context).each(function(){0!=$(this).val()&&$(this).closest(".element-component").addClass("show-lifeTimeDelay")})},prepareElementOverview:function($context){$("#elementImportLink").on("click",function(e){return e.preventDefault(),$("#importElements").toggle(),$(this).toggleClass("open"),!1})},prepareElementComponents:function($context){$(".form-section.size .form-elt input, .form-section.quantity .form-elt input",$context).each(function(){var $elt=$(this);if(1==$elt.length&&""===$elt.val())return $elt.focus(),!1}),this.prepareContent($context),this.prepareSortable($context),this.prepareElementSectionToggle($context),this.prepareCompositeElement($context)},prepareElementSectionToggle:function($context){var me=this;$context.is(".element-section")?me.addSectionToggle($(".legend",$context)):$(".element-section .legend",$context).each(function(){me.addSectionToggle($(this))})},addSectionToggle:function($legend){var cookieName="elca.section-"+$legend.closest("div.element-section").attr("id"),$toggler=$('<div class="section-toggle"></div>');$legend.after($toggler),Cookies&&Cookies.get(cookieName)&&($toggler.addClass("closed"),$toggler.nextAll().hide()),$toggler.click(function(e){$toggler.toggleClass("closed"),$toggler.nextAll().toggle(),Cookies&&Cookies.set(cookieName,$toggler.hasClass("closed"))})},prepareProcessConfigGeneral:function($context){var $checkbox=$(".form-section.opAsSupply input",$context),fnToggle=function(opAsSupply){opAsSupply?$(".form-section.opInvertValues",$context).show():$(".form-section.opInvertValues",$context).hide()};$checkbox.length&&(fnToggle($checkbox.is(":checked")),$checkbox.change(function(){fnToggle($checkbox.is(":checked"))}))},prepareLcaToggle:function($context){$("div.toggle-link",$context).each(function(){var lc=$(this).data("lc"),cookieName="elca.lcaToggle."+lc;lc&&(Cookies&&!Cookies.get(cookieName)&&($(this).removeClass("open"),$(this).nextAll("table").hide()),$(this).off("click").on("click",function(e){$(this).toggleClass("open"),$(this).nextAll("table").toggle(),Cookies.set(cookieName,$(this).hasClass("open"))}))})},prepareFilterList:function($context){var keyTimeout,$input=$("input.list-search",$context),$hint=$('<span class="hint">Mindestens 3 Zeichen eingeben!</span>'),loading=!1;$hint.hide(),$input.parent().append($hint),$input.attr("autocomplete","off").on("focus",function(){$input.data("prevVal",$input.val())}).off("change").on("change",function(e){loading||($input.val().length>2?($hint.fadeOut("fast"),$(this.form).ajaxForm({success:function(data,$form){loading=!1}}),loading=!0,$input.closest("form").submit()):$hint.fadeIn("fast"))}).on("input propertychange",function(e){window.clearTimeout(keyTimeout),keyTimeout=window.setTimeout(function(){$input.change()},500);var inputLen=$input.val().length,prevInputLen=$input.data("prevVal").length;!loading&&inputLen<1&&0!=prevInputLen&&$input.closest("form").submit(),$input.data("prevVal",$input.val())}),$(".filter-form select,.filter-form input:not(.list-search)",$context).on("change",function(){$(this.form).submit()})},prepareFilterTags:function($context){$('.filter-tags a.remove-filter[rel="reset"]',$context).on("click",function(e){e.preventDefault();var cssClass=$(this).parent().attr("class"),tag=$(this).parent().find(".tag-content").text();if("keyword"!==cssClass){var $filterControl=$(".filter-form [name="+cssClass+"]");$filterControl.is("select")?$filterControl.is("[disabled]")||$filterControl.val(""):$filterControl.is("input[type=radio]")&&($filterControl.prop("checked",!1),$filterControl.first().prop("checked",!0))}else{var $search=$(".filter-form input.list-search");$search.val($search.val().replace(tag,"").trim()),$(this).parent(".keyword").remove()}return $(".filter-form").submit(),!1})},preparePageable:function($context){var $ul,nextPageId=($ul=$context.is(".pageable")?$context:$("ul.pageable",$context)).data("next-page-id"),nextPageClass=$ul.data("next-page-class"),nextPageUrl=$ul.data("next-page-url");$ul.after('<ul id="'+nextPageId+'" class="'+nextPageClass+' pageable"></ul>'),$("li a.next-page",$context).atEndOfViewport(function(){var $item=this;$item.addClass("loading"),jBlibs.App.query(nextPageUrl,null,{complete:function(){$item.parent("li").remove()}})})},initTableScroll:function($context){$(window).width();var winHeight=$(window).height(),offset=$context.offset();$("table",$context).tableScroll({height:winHeight-offset.top-150})},prepareSvgPatternSelect:function($context){function setPatternImage($bgImage,img,$opt,maxWidth,maxHeight){$(img).load(function(e){$bgImage.css("background-image","url("+$opt.data("svg-pattern-url")+")"),img.naturalHeight>img.naturalWidth?$bgImage.css("background-size","80% auto"):$bgImage.css("background-size","auto 80%")}),img.src=$opt.data("svg-pattern-url")}$("div.elca-svg-pattern-select",$context).each(function(){var $bgImage=$("span.image",this),img=new Image,$imgContainer=($(img),$(".cell.select",this)),$opt=$("option:selected",this);$imgContainer.css("height",$imgContainer.height()),setPatternImage($bgImage,img,$opt,$imgContainer.width(),$imgContainer.height()),$(this).change(function(e){setPatternImage($bgImage,img,$("option:selected",this),$imgContainer.width(),$imgContainer.height())})})},preparePatternAssignments:function($context){$("li > .form-section .label-holder",$context).click(function(){var $labelHolder=$(this),$li=$labelHolder.parent().parent();if($li.toggleClass("open"),$li.data("url")&&!$li.data("loaded")){var data={},$changedSelect=$("select.changed",$labelHolder.siblings(".ElcaHtmlSvgPatternSelect"));$changedSelect.length&&(data.nodeChangedToPatternId=$changedSelect.val()),jBlibs.App.query($li.data("url"),data,{complete:function(){$li.data("loaded",!0)}})}else jBlibs.App.query("/elca/admin-svg-patterns/toggleCategory/",{nodeId:$li.data("id"),state:$li.hasClass("open")?1:0})}),$("ul.level2 > li",$context).each(function(){var $li=$(this);$(".categoryPatternId select",this).change(function(e){var $srcSelect=$(this);$(".configPatternId select",$li).each(function(){var $dstSelect=$(this);$dstSelect.data("orig-value")||$dstSelect.val($srcSelect.val()).change()})})})},prepareFinalEnergy:function($context){$(".final-energy-row.new .form-section:first input",$context).each(function(){var $elt=$(this);if(1==$elt.length&&""===$elt.val())return $elt.focus(),!1}),$(".toggle-link",$context).each(function(){$(this).click(function(e){console.log("click");var $parent=$(this).parent().attr("id"),$table=$("#"+$parent+" .results");return $table.is(":hidden")?($("#"+$parent+" .toggle").val(1),$(this).addClass("open"),$table.show()):($("#"+$parent+" .toggle").val(0),$(this).removeClass("open"),$table.hide()),!1})}),$(".toggle",$context).each(function(){var $parent=$(this).parent().attr("id"),$table=$("#"+$parent+" .results");1==$(this).val()&&($("#"+$parent+" .toggle-link").addClass("open"),$table.show())}),$("form",$context).ajaxForm({beforeSerialize:function($form,opts){opts.data={ngf:$("#enEvNgfAndVersion .ngf input").val(),enEvVersion:$("#enEvNgfAndVersion .enEvVersion input").val()}}})},prepareDetailInfoToggle:function($context){$("div.element-details-wrapper h3",$context).click(function(){var $header=$(this),$elementDetails=$header.next(".element-details");$header.data("loaded")||($header.addClass("loading"),jBlibs.App.query($header.data("url"),null,{complete:function(){$header.removeClass("loading"),$header.data("loaded",!0)}})),$header.toggleClass("open"),$elementDetails.toggle()})},prepareAdminBenchmarkVersion:function($context){$("#adminBenchmarkVersionForm input:radio[name=useReferenceModel]",$context).on("change",function(e){$(this.form).submit()}),$("a[rel=clearFields]",$context).on("click",function(e){return e.preventDefault(),$('.indicator-values input[value!=""]',$context).val(null).change(),!1}),$("a[rel=useDefaults]",$context).on("click",function(e){return e.preventDefault(),$(".indicator-values input",$context).each(function(){var $this=$(this);void 0!=$this.data("default")&&$this.val()!=$this.data("default")&&$this.val($this.data("default")).change()}),!1}),$context.is(".form-section.ElcaHtmlProcessConfigSelectorLink-section.changed")&&$("#adminBenchmarkVersionForm").addClass("changed"),$(".HtmlMultiSelectbox-section select",$context).selectize({create:!1,allowEmptyOption:!1,closeAfterSelect:!1,plugins:[{name:"remove_button",options:{className:"no-xhr"}}]}),$("#adminBenchmarksForm .input-container span.use-computed-value",$context).on("click",function(e){var $input=$(this).siblings("input");$input.val($input.data("computed-value"))})},prepareProjectGeneralView:function($context){var $processDbSelect=$(".fieldset:not(.read-only) #selectProcessDb"),$benchmarkVersionSelect=$("#selectBenchmarkSystem"),$constrClassSelect=$("select[name=constrClassId]"),$selectedConstrClassOption=$("option:selected",$constrClassSelect),$constrClassOptions=$("option",$constrClassSelect).detach(),$projectLifeTime=$("input[name=lifeTime]",$context),$livingSpaceElt=$(".form-section.livingSpace",$context),processDbIdOrig=$processDbSelect.val();function updateProcessDb(){var $selectedVersion=$("option:selected",$benchmarkVersionSelect),processDbId=$selectedVersion.data("process-db-id"),constrClassIds=$selectedVersion.data("constr-class-ids")||[],displayLivingSpace=parseInt($selectedVersion.data("display-living-space")),projectLifeTime=$selectedVersion.data("project-life-time");0===$selectedConstrClassOption.length&&($selectedConstrClassOption=$("option:first",$constrClassSelect)),processDbId?$processDbSelect.val(processDbId).attr("disabled","disabled").addClass("read-only"):$processDbSelect.removeAttr("disabled").removeClass("read-only"),constrClassIds.length>0?($constrClassSelect.empty().append($constrClassOptions.filter(function(index){return-1!==$.inArray(parseInt($(this).attr("value")),constrClassIds)})),$("option[value="+$selectedConstrClassOption.val()+"]",$constrClassSelect).length?$constrClassSelect.val($selectedConstrClassOption.val()):($constrClassSelect.val($("option:first",$constrClassSelect).val()),$selectedConstrClassOption=$("option:selected",$constrClassSelect),$constrClassSelect.addClass("changed"))):($constrClassSelect.empty().append($constrClassOptions),$constrClassSelect.val($selectedConstrClassOption.attr("value")));var $livingSpaceInput=$livingSpaceElt.find("input");return displayLivingSpace?($selectedVersion.val()?$livingSpaceElt.find("span.required").show():$livingSpaceElt.find("span.required").hide(),$livingSpaceElt.removeClass("hidden"),$livingSpaceInput.removeClass("read-only").prop("readonly",!1)):($livingSpaceElt.addClass("hidden"),$livingSpaceInput.addClass("read-only").prop("readonly",!0)),projectLifeTime?($projectLifeTime.val()!=projectLifeTime&&$projectLifeTime.addClass("changed"),$projectLifeTime.val(projectLifeTime).addClass("read-only").prop("readonly",!0)):($projectLifeTime.removeClass("read-only").prop("readonly",!1),$projectLifeTime.val()||$projectLifeTime.val(50).addClass("changed")),processDbId}$constrClassSelect.change(function(){$selectedConstrClassOption=$("option:selected",$constrClassSelect)}),updateProcessDb(),$benchmarkVersionSelect.change(function(){updateProcessDb()&&(null==processDbIdOrig?$processDbSelect.removeClass("changed"):$processDbSelect.addClass("changed"))})},prepareWindowAssistant:function($context){$("a[rel=toggle-mullion-transom-details]",$context).on("click",function(e){return e.preventDefault(),$(".mullions-transoms-dims",$context).toggle("hide"),$(this).toggleClass("closed"),!1}),$(".hasTopLight input",$context).on("change",function(){$(this).is(":checked")?$(".topLightHeight input",$context).removeAttr("readonly").removeAttr("disabled").removeClass("read-only"):$(".topLightHeight input",$context).attr("readonly","readonly").addClass("read-only")})},prepareStaircaseAssistant:function($context){var $typeElts=$('input[name="type"]',$context);showConstruction($typeElts.filter(":checked").val()),updateTrapezoidElements(),$typeElts.on("change",function(e){showConstruction($typeElts.filter(":checked").val()),updateTrapezoidElements()});var $solid1Share=$('input[name="solidMaterial1Share"]',$context),$solid2Share=$('input[name="solidMaterial2Share"]',$context);$solid1Share.on("change",function(e){$solid2Share.val(100-Math.max(0,Math.min(100,$solid1Share.val())))}),$solid2Share.on("change",function(e){$solid1Share.val(100-Math.max(0,Math.min(100,$solid2Share.val())))});$('.calcLength a[rel="set"]',$context).on("click",function(e){return e.preventDefault(),$(".construction:visible input.alternative-length",$context).val($(".construction:visible span.stepsLength",$context).text()).addClass("changed"),!1});function showConstruction(ident){ident&&($("div.construction.fieldset",$context).each(function(){var $elt=$(this);$elt.hasClass(ident)?$elt.show():$elt.hide()}),$("div.type-images img",$context).each(function(){var $elt=$(this);$elt.hasClass(ident)?$elt.show():$elt.hide()}))}function updateTrapezoidElements(){var $isTrapezoid=$(".form-section.isTrapezoid input",$context),$length2=$(".form-section.coverLength2 input",$context);"middle-holm"==$typeElts.filter(":checked").val()?($(".form-section.isTrapezoid",$context).show(),$(".form-section.coverLength2",$context).show(),disable($length2,!$isTrapezoid.is(":checked")),$isTrapezoid.on("change",function(){disable($length2,!$isTrapezoid.is(":checked"))})):($(".form-section.isTrapezoid",$context).hide(),$(".form-section.coverLength2",$context).hide())}function disable($elt,state){state?$elt.attr("readonly","readonly").addClass("read-only"):$elt.removeAttr("readonly").removeClass("read-only")}},preparePillarAssistant:function($context){var $typeElts=$('input[name="shape"]',$context);showConstruction($typeElts.filter(":checked").val()),$typeElts.on("change",function(e){showConstruction($typeElts.filter(":checked").val())});var $share1=$('input[name="material1Share"]',$context),$share2=$('input[name="material2Share"]',$context);function showConstruction(ident){ident&&($("div.properties.fieldset .shape-properties",$context).each(function(){var $elt=$(this);$elt.hasClass(ident)?$elt.show():$elt.hide()}),$("div.type-images img",$context).each(function(){var $elt=$(this);$elt.hasClass(ident)?$elt.show():$elt.hide()}))}$share1.on("change",function(e){$share2.val(100-Math.max(0,Math.min(100,$share1.val())))}),$share2.on("change",function(e){$share1.val(100-Math.max(0,Math.min(100,$share2.val())))})},prepareProjectTransports:function($context){if($("#transports .matProcessConfigId select",$context).change(function(){var selValue=$(this).val(),$opt=$("option[value="+selValue+"]",this),quantity=$opt.data("quantity"),name=$opt.text(),$liTransport=$(this).parents("li.transport");$liTransport.find(".name input").val(selValue?name:""),$liTransport.find(".quantity input").val(quantity)}),$context.is("ul")){var relId=$context.data("rel-id");$("li#transport-mean-"+relId+" .distance input",$context).focus()}$(".toggle-link",$context).each(function(){$(this).click(function(e){var $parent=$(this).parent().attr("id"),$table=$("#"+$parent+" .process-databases");return $table.is(":hidden")?($("#"+$parent+" .toggle").val(1),$(this).addClass("open"),$table.show()):($("#"+$parent+" .toggle").val(0),$(this).removeClass("open"),$table.hide()),!1})}),$(".toggle",$context).each(function(){var $parent=$(this).parent().attr("id"),$table=$("#"+$parent+" .process-databases");1==$(this).val()&&($("#"+$parent+" .toggle-link").addClass("open"),$table.show())})},prepareProcessSanity:function($context){var reference=$.url(jBlibs.App.getHashUrl()).param("r"),$processSanityTable=$("#processSanityTable"),me=this,epdModulesFilter=$("#epdModulesFilter").selectize({create:!1,allowEmptyOption:!1,closeAfterSelect:!1,plugins:[{name:"remove_button",options:{className:"no-xhr"}}]}),table=$processSanityTable.DataTable({dom:'<"dt-wrapper"lpBtip>',lengthMenu:[[25,50,100,-1],[25,50,100,$processSanityTable.data("all-caption")]],ajax:{url:"/sanity/processes/sanitiesJson/",dataSrc:"processes"},columns:[{data:"refNum"},{data:"processConfigName",render:function(data,type,row,meta){return'<a class="page" href="/processes/'+row.processConfigId+"/?back=ref"+row.id+'">'+data+"</a>"}},{data:"processDbName"},{data:"epdTypes"},{data:"epdModules"},{data:"status"},{data:"isFalsePositive",orderable:!1,render:function(data,type,row,meta){return"display"!==type?data:'<input name="falsePositive" type="checkbox" value="'+row.id+'" '+(data?'checked="checked"':"")+"/>"}},{data:"isReference",orderable:!1,render:function(data,type,row,meta){return"display"!==type?data:'<input name="isReference" type="checkbox" value="'+row.processConfigId+'" '+(data?'checked="checked"':"")+"/>"}}],createdRow:function(row,data,dataIndex){$(row).attr("id","ref"+data.id),data.isReference||$(row).addClass("inactive")},columnDefs:[{targets:[6,7],createdCell:function(td,cellData,rowData,row,col){$(td).data("filter",cellData)}}],stateSave:!0,drawCallback:function(){me._prepare($processSanityTable)},initComplete:function(settings,json){var columnIndex,selector,column,savedState,$input,dataTable=this;if(columnIndex=1,selector="tr.filter th.process-config input",column=dataTable.api().column(columnIndex),savedState=dataTable.api().column(columnIndex).search(),($input=$(selector)).off("keyup change").on("keyup change",function(){savedState!==this.value&&column.search(this.value,!0,!1).draw(),$(column.header()).toggleClass("active-filter",!!this.value)}),savedState.length&&($input.val(savedState),$(column.header()).addClass("active-filter")),selectFilter(2,"tr.filter th.process-db select"),selectFilter(3,"tr.filter th.epd-sub-type select"),function(columnIndex,selectize){var column=dataTable.api().column(columnIndex),savedState=dataTable.api().column(columnIndex).search();if(selectize.off("change").on("change",function(){var regex,value=selectize.val();value&&(regex=value.sort().map(function(item){return $.fn.dataTable.util.escapeRegex(item)}).join(".+?")),column.search(regex?"("+regex+")":"",!0,!1).draw(),$(column.header()).toggleClass("active-filter",!!value)}),savedState.length){var selectedOpts=savedState.replace(/\\(.)/g,"$1").replace(/^\((.+)\)$/,"$1").split(/\.\+\?/);selectize[0].selectize.setValue(selectedOpts,!0),$(column.header()).addClass("active-filter")}}(4,epdModulesFilter),selectFilter(5,"tr.filter th.error-status select"),checkboxFilter(6,"tr.filter th.false-positive input"),checkboxFilter(7,"tr.filter th.is-reference input"),reference){var $row=$("#"+reference),$window=$(window);$row.length&&($window.scrollTop($row.offset().top-$window.height()/2),$row.addClass("glow"))}function selectFilter(columnIndex,selector){var column=dataTable.api().column(columnIndex),savedState=dataTable.api().column(columnIndex).search(),select=$(selector).on("change",function(){var val=$(this).val();column.search(val||"",!1,!1).draw(),$(column.header()).toggleClass("active-filter",!!val)});savedState&&(select.find("option").each(function(){var value=$(this).val();savedState===value&&select.val(value)}),$(column.header()).addClass("active-filter"))}function checkboxFilter(columnIndex,selector){var column=dataTable.api().column(columnIndex),savedState=dataTable.api().column(columnIndex).search(),$input=$(selector),clickTimer=null;$input.off("click").on("click",function(e){null===clickTimer&&(clickTimer=window.setTimeout(function(){var state=$input.is(":checked")?"true":"false";column.search(state,!1,!1).draw(),clickTimer=null},300),$(column.header()).addClass("active-filter"))}),$input.off("dblclick").on("dblclick",function(e){clearTimeout(clickTimer),clickTimer=null,$input.prop("indeterminate",!0),column.search("",!1,!1).draw(),$(column.header()).removeClass("active-filter")}),savedState.length?($input.prop("checked","true"===savedState),$(column.header()).addClass("active-filter")):($input.prop("indeterminate",!0),$(column.header()).removeClass("active-filter"))}table.$("td input").on("change",function(){$(this).addClass("changed"),table.button(1).enable()})},autoWidth:!1,language:{lengthMenu:$processSanityTable.data("per-page-caption"),zeroRecords:$processSanityTable.data("zero-records-caption"),info:$processSanityTable.data("current-page-caption"),infoFiltered:$processSanityTable.data("info-filtered-caption"),infoEmpty:$processSanityTable.data("zero-records-caption"),search:$processSanityTable.data("search-caption"),paginate:{first:$processSanityTable.data("first-caption"),last:$processSanityTable.data("last-caption"),next:$processSanityTable.data("next-caption"),previous:$processSanityTable.data("previous-caption")},decimal:",",thousands:".",buttons:{selectNone:$processSanityTable.data("select-none-caption")},select:{rows:{1:$processSanityTable.data("selected-row-caption"),0:"",_:$processSanityTable.data("selected-rows-caption")}}},buttons:[{name:"clearAllFilters",text:$processSanityTable.data("clear-all-filters-caption"),action:function(e,dt,node,config){table.columns().every(function(){this.search("")}),$processSanityTable.find('.filter select,.filter input[type="text"]').val(""),$processSanityTable.find('.filter select,.filter input[type="checkbox"]').prop("indeterminate",!0),$processSanityTable.find("th").removeClass("active-filter"),epdModulesFilter[0].selectize.clear(!0),table.state.clear(),table.state.save(),table.search("").draw()}},{name:"Speichern",text:$processSanityTable.data("save-caption"),action:function(e,dt,node,config){var falsePositive=table.$('input[name="falsePositive"].changed').map(function(){return{id:this.value,value:$(this).is(":checked")}}).toArray(),isReference=table.$('input[name="isReference"].changed').map(function(){return{id:this.value,value:$(this).is(":checked")}}).toArray();return jBlibs.App.query("/sanity/processes/save/",{falsePositive:falsePositive,isReference:isReference},{httpMethod:"POST",success:function(){table.$('input[name="isReference"].changed').each(function(){var tr=$(this).parents("tr");$(this).is(":checked")?tr.removeClass("inactive"):tr.addClass("inactive")}),table.$("td input.changed").removeClass("changed")}}),!1},enabled:!1}]})}},modalBox:{autoComplete:{cache:{},lastXhr:null},initialize:function(){$.widget("custom.catcomplete",$.ui.autocomplete,{_renderMenu:function(ul,items){var self=this,currentCategory="";$.each(items,function(index,item){item.category!=currentCategory&&(ul.append("<li class='ui-autocomplete-category'>"+item.category+"</li>"),currentCategory=item.category),self._renderItemData(ul,item)})}})},views:{"#elca-modal-content":"prepareContent","#elca-modal-content.process-selector":"prepareProcessSelector","#elca-modal-content.process-config-selector-modal":"prepareProcessConfigSelector","#elca-modal-content.element-selector,div.element":"prepareElementSelector","#elca-modal-content.template-element-selector,div.element":"prepareTemplateElementSelector","#content.elements,#content.project-elements":null,"#content.elca-admin-benchmark-version,div.ElcaHtmlProcessConfigSelectorLink-section.refProcessConfigId":null,"#tabContent":null,"div.process-assignment,div.process-group":null,"div.element-section,#element-layers,#element-components,div.element-component":null,"#content.project-final-energy":null,"#content.project-transports,ul.transport-means":null,"#elca-modal-content.processing":"prepareProcessing","div.ElcaHtmlProcessConfigSelectorLink-section.assistant":null,"div.ElcaHtmlElementSelectorLink-section.assistant":null,"#templateElement":null,"#content.report":null,"#elca-modal-content.pdf-gen":"preparePdf","#elca-modal-content.project-access":"prepareProjectAccess","#content.report":"checkCreatePdf","#content.elca-project":null,"#projectProcessConfigSanity":null,"#content.project-import":null,"#content.admin-mapping-edit":null,".import-assistant-mapping-selector":null,"#content.replace-components, #content.replace-elements":null,"#content.project-csv-import.preview":null},controls:{"a[rel=open-modal]":{click:{target:"href",success:function(){$("#elca-modal").fadeIn("fast")}}},"a[rel=close-modal]":{click:function(){return $("#elca-modal").fadeOut("fast",function(){$("#elca-modal-content").empty()}),!1}}},prepareProjectAccess:function($context){$("#projectAccessForm input[type=submit]").click(function(e){return $("#elca-modal").fadeOut("fast"),!0})},preparePdf:function($context){$("div.spinning-wheel",$context).each(function(){var $container=$(this);$container.data("action")&&jBlibs.App.query($container.data("action"),null,{complete:function(xhr,response){$context.removeClass("spin").addClass("done"),jBlibs.App._replaceView(response.responseJSON)},error:function(xhr,textStatus,errThrown){alert("Error: "+xhr.responseText)}}),$container.data("close-after-time-in-ms")&&setTimeout(function(){$("#elca-modal").fadeOut("fast",function(){$("#elca-modal-content").empty()})},$container.data("close-after-time-in-ms"))})},checkCreatePdf:function($context){function checkPDFReady($container,$counter,$action){return $container.data("check")&&($.ajax({global:!1,url:$action,dataType:"json",data:{id:$container.data("id"),pvid:$container.data("pvid"),uid:$container.data("uid"),action:$container.data("action")},success:function(data,status,xhr){1==data.created&&(clearTimeout(checktimer),window.location.reload())}}),checktimer=setTimeout(function(){checkPDFReady($container,$counter,$action)},1e4)),!0}$("span.pdfcreate",$context).each(function(){checkPDFReady($(this),0,"/project-reports/testpdfvar/")})},prepareContent:function($context){var me=this;$("#elca-modal-content").is(":empty")||$("#elca-modal").fadeIn("fast"),$(".modal-selector-form input[type=submit]").click(function(e){return me.clearCache(),$("#elca-modal").fadeOut("fast"),!0})},prepareProcessSelector:function($context){$("#elca-process-search",$context).catcomplete({minLength:2,source:function(request,response){request.term;$.ajax({global:!1,url:this.element.data("url"),dataType:"json",data:{term:request.term,lc:this.element.data("life-cycle"),processDbId:this.element.data("process-db-id")},success:function(data,status,xhr){response(data.results)}})},select:function(event,ui){return $("#processSelectorForm select[name=id]").val(""),$("#processSelectorForm input[name=p]").val(ui.item.id),$("#processSelectorForm select[name=processCategoryNodeId]").val(ui.item.catId).change(),!1}})},prepareProcessConfigSelector:function($context){var $buttons=$(".buttons.fieldset",$context);$("#elca-process-config-search",$context).catcomplete({minLength:2,source:function(request,response){request.term;$.ajax({global:!1,url:this.element.data("url"),dataType:"json",data:{term:request.term,u:this.element.data("in-unit"),b:this.element.data("build-mode"),db:this.element.data("db"),compatdbs:this.element.data("compatdbs"),filterByProjectVariantId:this.element.data("filter-project-variant-id"),epdSubType:this.element.data("epd-sub-type")},success:function(data,status,xhr){response(data.results)}})},select:function(event,ui){return $("#processConfigSelectorForm select[name=id]").val(""),$("#processConfigSelectorForm input[name=sp]").val(ui.item.id),$("#processConfigSelectorForm select[name=processCategoryNodeId]").val(ui.item.catId).change(),!1}}),$(document).one("ajaxSend",function(e){$buttons.find("input").prop("disabled",!0),$buttons.css("opacity",.4)}),$("#layer-info").html(function(){return $(this).text()})},prepareElementSelector:function($context){var $buttons=$(".buttons.fieldset",$context);$("#elca-element-search",$context).catcomplete({minLength:2,source:function(request,response){request.term;var searchMode=$("#elementSelectorForm input[name=mode]").fieldValue()[0],searchScope=$("#elementSelectorForm input[name=scope]").fieldValue()[0];$.ajax({global:!1,url:this.element.data("url"),dataType:"json",data:{term:request.term,ce:this.element.data("rel-id"),m:searchMode,scope:searchScope,compatdbs:this.element.data("compatdbs")},success:function(data,status,xhr){response(data.results)}})},select:function(event,ui){return $("#elementSelectorForm *[name=id]").val(ui.item.id),$("#elementSelectorForm select[name=elementTypeNodeId]").val(ui.item.catId).change(),!1}}),$(document).one("ajaxSend",function(e){$buttons.find("input").prop("disabled",!0),$buttons.css("opacity",.4)})},prepareTemplateElementSelector:function($context){var $buttons=$(".buttons.fieldset",$context),$elementTemplateSelectorForm=$("#templateElementSelectorForm");$("#elca-element-search",$context).catcomplete({minLength:2,source:function(request,response){request.term;var searchScope=$elementTemplateSelectorForm.find("input[name=scope]").fieldValue()[0];$.ajax({global:!1,url:this.element.data("url"),dataType:"json",data:{term:request.term,elementTypeNodeId:this.element.data("element-type-node-id"),scope:searchScope,compatdbs:this.element.data("compatdbs")},success:function(data,status,xhr){response(data.results)}})},select:function(event,ui){return $elementTemplateSelectorForm.find("*[name=id]").val(ui.item.id),$elementTemplateSelectorForm.find("select[name=elementTypeNodeId]").val(ui.item.catId).change(),!1}}),$(document).one("ajaxSend",function(e){$buttons.find("input").prop("disabled",!0),$buttons.css("opacity",.4)})},prepareProcessing:function($context){$("div.spinning-wheel",$context).each(function(){var $container=$(this);$container.data("action")&&jBlibs.App.query($container.data("action"),null,{complete:function(){$context.removeClass("spin").addClass("done"),$container.data("reload")&&jBlibs.App.query(jBlibs.App.getHashUrl()),window.setTimeout(function(){$("#elca-modal").fadeOut("fast",function(){$("#elca-modal-content").empty()})},2e3)},error:function(xhr,textStatus,errThrown){alert("Error: "+xhr.responseText)}})})},clearCache:function(){this.autoComplete.cache={}}},msgBox:{onLoad:function(e,xhr,settings){},views:{"#msgBox":function($msgBox){if(!$msgBox.is(".notice, .info, .error, .confirm"))return $msgBox.hide();$msgBox.slideDown("fast"),$msgBox.is(".info, .error, .confirm")||window.setTimeout(function(){$msgBox.slideUp("fast"),$msgBox.removeClass("info notice error confirm")},2e3),$msgBox.unbind("click"),$msgBox.is(".confirm")?($("a, span.cancel",$msgBox).click(function(e){return $(this).parents("li").remove(),0==$("a",$msgBox).length&&($msgBox.slideUp(),$msgBox.removeClass("info notice error confirm")),$(document).off("keydown"),e.preventDefault(),!1}),$(document).keypress(function(e){switch(e.keyCode?e.keyCode:e.which){case 13:$("a.confirm",$msgBox).click(),e.preventDefault();break;case 27:e.preventDefault()}})):($msgBox.click(function(){$msgBox.slideUp("fast"),$msgBox.removeClass("info notice error confirm")}),window.setTimeout(function(){$msgBox.off("click"),$msgBox.slideUp()},8e3))}}},navigation:{views:{"#navLeft":["initNavLeft","highlightMissingTranslations"],"#navLeft.elements":["initElementsNav","highlightMissingTranslations"],"#navLeft.project-elements":"initProjectElementsNav","#tabContent":["setActiveTab","highlightMissingTranslations"]},controls:{"a.page:not(.no-xhr)":{click:"href"}},highlightMissingTranslations:function($context){$("body.hl-mi-tr *").contents().filter(function(){return 3===this.nodeType&&/\_\_\*\*(.+?)\*\*\_\_/m.test(this.textContent)}).highlightMissingTranslation()},setActiveTab:function($context){$.each($context.attr("class").split(/ /),function(i,tabId){if(tabId.match(/tab-/))return $("#content .elca-tabs .elca-tab").removeClass("active").filter("#"+tabId).addClass("active"),!1})},initNavLeft:function($context){$("li.open ul.nav-toggle-item:hidden",$context).show(),$("h4.nav-toggle",$context).click(function(e){var toggleItem=$(this).next("ul");toggleItem.is(":hidden")?($("li.open ul.nav-toggle-item:not(:hidden)",$context).each(function(){$(this).slideUp("fast"),$(this).parent("li").removeClass("open")}),$(this).parent("li").addClass("open"),toggleItem.slideDown("fast")):($(this).parent("li").removeClass("open"),toggleItem.slideUp("fast"))})},initProjectElementsNav:function($context){var $compareForm=$context.find('form[name="compareWithReferenceProjectForm"]'),$compareToggle=$compareForm.find(".compare input"),$indicatorSelect=$compareForm.find(".indicatorId");function compareWithRefProjectForm(hideImmediately){$compareToggle.is(":checked")?$indicatorSelect.fadeIn():hideImmediately?$indicatorSelect.hide():$indicatorSelect.fadeOut()}compareWithRefProjectForm(!0),$compareForm.on("change",function(e){compareWithRefProjectForm(),$compareForm.ajaxSubmit()}),$context.find("li.navigation").each(function(){var $li=$(this),value=$li.data("ref-project"),deviation=$li.data("ref-project-deviation");if(value){var $refIndicator=$('<span class="ref-project '+value+'"></span>');$refIndicator.attr("title",deviation+" %"),$(this).append($refIndicator)}})},initElementsNav:function($context){$("h3",$context).each(function(index){var cookieName="elca.elementsNavToggle."+index;void 0==Cookies.get(cookieName)&&Cookies.set(cookieName,!0),Cookies&&!Cookies.get(cookieName)&&($(this).addClass("close"),$(this).next().hide()),$(this).off("click").on("click",function(e){$(this).toggleClass("close"),$(this).next().toggle(),Cookies.set(cookieName,!$(this).hasClass("close"))})})}},charts:{views:{"#content.report":"prepareCharts","#content.report-summary-benchmarks":"prepareBenchmarks","#content.project-final-energy":"prepareFinalEnergyKwkPieChart"},prepareCharts:function($context){var self=this,$charts=$("div.chart",$context),chartCount=$charts.length,$progressElt=$("#progress"),$printButton=$("div.print.button a",this);chartCount>0?$printButton.fadeTo("fast",.1):window.status="ready_to_print",console.debug("start loading charts: "+chartCount),$charts.each(function(i){var $this=$(this),url=$this.data("url"),load=0;window.setTimeout(function(){$this.hasClass("bar-chart")?self.updateBarChart(url,$this):$this.hasClass("stacked-bar-chart")?self.updateStackedBarChart(url,$this):$this.hasClass("grouped-stacked-bar-chart")?self.updateGroupedStackedBarChart(url,$this):$this.hasClass("pie-chart")&&self.prepareFinalEnergyKwkPieChart($context),load=(i+1)/chartCount,$progressElt.html($("#diagramsLoading").text()+" "+Math.round(100*load)+"%"),1===load?($printButton.fadeTo("normal",1),window.setTimeout(function(){$progressElt.fadeOut("fast"),window.status="ready_to_print"},1e3)):$progressElt.fadeIn()},200*i)}),$(".reportTopForm input",$context).off("keypress"),$(".reportForm select,.reportForm input,.reportTopForm input,.reportTopForm select",$context).on("change ",function(){$(this.form).submit()})},updateBarChart:function(url,$container){d3.json(url).header("X-Requested-With","XMLHttpRequest").get(function(error,response){var conf=response.config,data=response.data||[],bGroup=null;if(data.length){var barChart=new elca.charts.BarChart($container[0],conf);$container.hasClass("benchmark-chart")&&(bGroup=barChart.svg.append("g")),barChart.updateData(data),$container.hasClass("benchmark-chart")&&$.each([{c:"gold",from:80,to:100},{c:"silver",from:70,to:80},{c:"bronze",from:60,to:70}],function(){bGroup.append("line").attr("class","benchmark "+this.c).attr("x1",20).attr("y1",Math.floor(barChart.y(this.from))).attr("x2",barChart.width-20).attr("y2",Math.floor(barChart.y(this.from)))})}})},updateStackedBarChart:function(url,$container){d3.json(url).header("X-Requested-With","XMLHttpRequest").get(function(error,response){var bGroup,conf=response.config,data=response.data||[];data.length&&$container.fadeOut(function(){$container.empty();var charts=new elca.charts.StackedBarChart($container[0],conf,data);$container.hasClass("benchmark-chart")&&(bGroup=charts.svg.append("g")),charts.updateData(data),$container.hasClass("benchmark-chart")&&$.each([{c:"max",from:100},{c:"p80",from:80},{c:"p60",from:60},{c:"p40",from:40},{c:"p20",from:20}],function(){bGroup.append("line").attr("class","benchmark "+this.c).attr("x1",5).attr("y1",Math.floor(charts.y(this.from))).attr("x2",charts.width-5).attr("y2",Math.floor(charts.y(this.from)))}),$container.fadeIn()})})},updateGroupedStackedBarChart:function(url,$container){d3.json(url).header("X-Requested-With","XMLHttpRequest").get(function(error,response){var conf=response.config,data=response.data||[];data.length&&$container.fadeOut(function(){$container.empty();new elca.charts.GroupedStackedBarChart($container[0],conf,data);$container.fadeIn()})})},prepareBenchmarks:function($context){if(!$("body.pdf").length){var $container=$(".indicator-charts",$context),$cycler=$(".cycler",$container);$container.append('<div id="indicator-charts-pager" class="cycle-pager">Indikatoren </div>'),$cycler.cycle({timeout:0,slides:"> .ref-model-chart",pager:"#indicator-charts-pager"})}},prepareFinalEnergyKwkPieChart:function($context){var $chart=$(".pie-chart",$context);if(0!==$chart.length){var data=$chart.data("values"),self=this,radius=Math.min(100,100)/2,color=d3.scale.ordinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),arc=d3.svg.arc().outerRadius(radius-10).innerRadius(0),pie=d3.layout.pie().sort(null).value(function(d){return d.value}),svg=d3.select($chart[0]).append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 100 100").append("g").attr("transform","translate(50,50)");data.forEach(function(d){d.value=+d.value,d.text=(d.name+" "+Math.round(100*d.value*10)/10+"%").replace(".",",");var newEmSize=8/d.text.length;d.fontSize=newEmSize<1?8*newEmSize+"px":"1px"}),this.tooltip=d3.select($chart[0]).append("div").attr("class","tooltip").style("opacity",0);var g=svg.selectAll(".arc").data(pie(data)).enter().append("g").attr("class","arc");g.append("path").attr("d",arc).style("fill",function(d){return"undefined"===d.data.class?"#FF0000":color(d.data.name)}).on("mouseover",function(d){var coords=d3.mouse($chart[0]);self.tooltip.transition().duration(200).style("opacity",.9),self.tooltip.text(d.data.text).style("left",coords[0]+"px").style("top",coords[1]-12+"px")}).on("mouseout",function(d){self.tooltip.transition().duration(500).style("opacity",0)}),g.append("text").attr("transform",function(d){return"translate("+arc.centroid(d)+")"}).attr("dy",".35em").style("text-anchor","middle").style("font-size",function(d){return d.data.fontSize}).text(function(d){return d.data.text})}}}}})}),function(window,$,d3,undefined){var elca=window.elca=window.elca||{};elca.charts=elca.charts=elca.charts||{BarChart:function(container,conf,data){if(!(this instanceof arguments.callee))throw Error("Constructor called as a function");this._defaults={width:500,height:200,margin:{top:10,right:20,bottom:30,left:40},yAxis:{caption:"",refUnit:""}},this.conf={},this.width=null,this.height=null,this.x=null,this.y=null,this.xAxis=null,this.yAxis=null,this.svg=null,this.updateData=function(data){var self=this;this.x.domain(data.map(function(d){return d.name})),this.y.domain([0,d3.max(data,function(d){return+d.value})]),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(this.xAxis).selectAll("text").style("text-anchor","end").attr("dy","1em").attr("transform",function(d){return"rotate(-45)"}),this.svg.append("g").attr("class","y axis").call(this.yAxis).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(this.conf.yAxis.caption+" "+this.conf.yAxis.wordingIn+" "+this.conf.yAxis.refUnit),this.svg.selectAll(".bar").data(data).enter().append("rect").attr("class","bar").attr("x",function(d){return self.x(d.name)}).attr("width",this.x.rangeBand()).attr("y",function(d){return self.y(d.value)}).attr("height",function(d){return self.height-self.y(d.value)}).on("mouseover",function(d){var coords=d3.mouse(container);self.tooltip.transition().duration(200).style("opacity",.9),self.tooltip.html(d.name.replace(/\n/g,"<br />")+"<br/>"+d.value+" "+self.conf.yAxis.refUnit).style("left",coords[0]+"px").style("top",coords[1]-12+"px")}).on("mouseout",function(d){self.tooltip.transition().duration(500).style("opacity",0)})},this.getSvg=function(){return this.svg},this._init=function(container,conf){this.conf=$.extend(!0,this.conf,this._defaults,conf),this.width=this.conf.width-this.conf.margin.left-this.conf.margin.right,this.height=this.conf.height-this.conf.margin.top-this.conf.margin.bottom,this.x=d3.scale.ordinal().rangeRoundBands([0,this.width],.5),this.y=d3.scale.linear().range([this.height,0]),this.xAxis=d3.svg.axis().scale(this.x).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.y).orient("left"),this.svg=d3.select(container).append("svg").attr("width",this.width+this.conf.margin.left+this.conf.margin.right).attr("height",this.height+this.conf.margin.top+this.conf.margin.bottom).append("g").attr("transform","translate("+this.conf.margin.left+","+this.conf.margin.top+")"),this.tooltip=d3.select(container).append("div").attr("class","tooltip").style("opacity",0)},this._init(container,conf),data&&this.updateData(data)},StackedBarChart:function(container,conf,data){if(!(this instanceof arguments.callee))throw Error("Constructor called as a function");this._defaults={width:500,height:200,margin:{top:10,right:20,bottom:30,left:40},yAxis:{caption:"",refUnit:"",minValue:0}},this.conf={},this.width=null,this.height=null,this.x=null,this.y=null,this.xAxis=null,this.yAxis=null,this.svg=null,this.color=d3.scale.ordinal().range(["#3b486b","#ff8c00","#93cd00"]),this.updateData=function(data){var self=this;data.forEach(function(d){var py0=0,ny1=0;d.values.forEach(function(i){+i.value>=0?(i.py0=py0,i.py1=py0+=+i.value):(i.ny1=ny1,i.ny0=ny1+=+i.value)})});var minValue=1.2*d3.min(data,function(d){return d3.min(d.values,function(i){return+i.ny0})}),maxValue=d3.max(data,function(d){return d3.max(d.values,function(i){return+i.py1})}),dataMap={};this.x.domain(data.map(function(d){return dataMap[d.name]={info:d.info,cssClass:d.cssClass},d.name})),this.y.domain([minValue<0?minValue:0,this.conf.yAxis.atLeastMaxValue>maxValue?this.conf.yAxis.atLeastMaxValue:maxValue]),this.color.domain(data[0].values.map(function(d){return d.name})),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(this.xAxis).selectAll("text").style("text-anchor","end").attr("dy","1em").attr("transform","rotate(-45)").attr("title",function(d){return dataMap[d].info}).attr("class",function(d){return dataMap[d].cssClass}),this.svg.append("g").attr("class","y axis").call(this.yAxis).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(this.conf.yAxis.caption+" "+this.conf.yAxis.wordingIn+" "+this.conf.yAxis.refUnit),this.svg.selectAll(".stack").data(data).enter().append("g").attr("class","stack").attr("transform",function(d,i){return"translate("+(self.x(d.name)+self.x.rangeBand()/2-15)+", 0)"}).selectAll(".bar").data(function(d){return d.values}).enter().append("rect").attr("class","bar").attr("x","0").attr("width","30px").attr("y",function(d){return self.y(d.value>=0?d.py1:d.ny1)}).attr("height",function(d){return self.y(d.value>=0?d.py0:d.ny0)-self.y(d.value>=0?d.py1:d.ny1)}).style("fill",function(d){return d.fill?d.fill:self.color(d.name)}).on("mouseover",function(d){var coords=d3.mouse(container);self.tooltip.transition().duration(200).style("opacity",.9),self.tooltip.html(d.name.replace(/\n/g,"<br />")+"<br/>"+d.value+" "+self.conf.yAxis.refUnit).style("left",coords[0]+"px").style("top",coords[1]-12+"px")}).on("mouseout",function(d){self.tooltip.transition().duration(500).style("opacity",0)}),this.svg.append("line").attr("class","line0").attr("x1",0).attr("x2",this.width).attr("y1",this.y(0)).attr("y2",this.y(0))},this.getSvg=function(){return this.svg},this._init=function(container,conf){this.conf=$.extend(!0,this.conf,this._defaults,conf),this.width=this.conf.width-this.conf.margin.left-this.conf.margin.right,this.height=this.conf.height-this.conf.margin.top-this.conf.margin.bottom,this.x=d3.scale.ordinal().rangeRoundBands([0,this.width],.2),this.y=d3.scale.linear().range([this.height,0]),this.xAxis=d3.svg.axis().scale(this.x).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.y).orient("left").tickFormat(d3.format(".2s")),this.svg=d3.select(container).append("svg").attr("width",this.width+this.conf.margin.left+this.conf.margin.right).attr("height",this.height+this.conf.margin.top+this.conf.margin.bottom).append("g").attr("transform","translate("+this.conf.margin.left+","+this.conf.margin.top+")"),this.tooltip=d3.select(container).append("div").attr("class","tooltip").style("opacity",0)},this._init(container,conf),data&&this.updateData(data)},GroupedStackedBarChart:function(container,conf,data){if(!(this instanceof arguments.callee))throw Error("Constructor called as a function");this._defaults={width:500,height:200,margin:{top:10,right:20,bottom:30,left:40},yAxis:{caption:"",refUnit:""}},this.conf={},this.width=null,this.height=null,this.x0=null,this.x1=null,this.y=null,this.xAxis=null,this.yAxis=null,this.svg=null,this.color=d3.scale.ordinal().range(["#3b486b","#ff8c00","#93cd00"]),this.updateData=function(data){var self=this;data.forEach(function(d){d.groups.forEach(function(g){var py0=0,ny1=0;g.stacks.forEach(function(s){s.py0=s.py1=s.ny0=s.ny1=0,+s.value>=0?(s.py0=py0,s.py1=py0+=+s.value):(s.ny1=ny1,s.ny0=ny1+=+s.value)}),g.textY=py0})});var minValue=1.2*d3.min(data,function(d){return d3.min(d.groups,function(g){return d3.min(g.stacks,function(s){return+s.ny0})})}),maxValue=1.2*d3.max(data,function(d){return d3.max(d.groups,function(g){return d3.max(g.stacks,function(s){return+s.py1})})}),dataMap={};this.x0.domain(data.map(function(d){return dataMap[d.name]={info:d.info,cssClass:d.cssClass},d.name})),this.x1.rangeRoundBands([0,this.x0.rangeBand()],.2),this.x1.domain(data[0].groups.map(function(d){return d.name})),this.y.domain([minValue<0?minValue:0,maxValue]),this.svg.append("g").attr("class","x axis").attr("transform","translate(0,"+this.height+")").call(this.xAxis).selectAll("text").style("text-anchor","end").attr("dy","1em").attr("transform","rotate(-45)").attr("title",function(d){return dataMap[d].info}).attr("class",function(d){return dataMap[d].cssClass}),this.svg.append("g").attr("class","y axis").call(this.yAxis).append("text").attr("transform","rotate(-90)").attr("y",6).attr("dy",".71em").style("text-anchor","end").text(this.conf.yAxis.caption+" "+this.conf.yAxis.wordingIn+" "+this.conf.yAxis.refUnit);var stacks=this.svg.selectAll(".group").data(data).enter().append("g").attr("class","group").attr("transform",function(d){return"translate("+self.x0(d.name)+", 0)"}).selectAll(".stack").data(function(d){return d.groups}).enter().append("g").attr("class","stack").attr("transform",function(d){return"translate("+self.x1(d.name)+", 0)"});stacks.selectAll(".bar").data(function(d){return d.stacks}).enter().append("rect").attr("class","bar").attr("x","0").attr("width",self.x1.rangeBand()).attr("y",function(d){return self.y(d.value>=0?d.py1:d.ny1)}).attr("height",function(d){return self.y(d.value>=0?d.py0:d.ny0)-self.y(d.value>=0?d.py1:d.ny1)}).style("fill",function(d){return d.fill?d.fill:self.color(d.name)}).on("mouseover",function(d){var coords=d3.mouse(container);self.tooltip.transition().duration(200).style("opacity",.9),self.tooltip.html(d.name.replace(/\n/g,"<br />")+"<br/>"+d.value+" "+self.conf.yAxis.refUnit).style("left",coords[0]+"px").style("top",coords[1]-12+"px")}).on("mouseout",function(d){self.tooltip.transition().duration(500).style("opacity",0)}),stacks.append("text").attr("x",function(d){return self.x1.rangeBand()/2}).attr("y",function(d){return self.y(d.textY)}).attr("dx","-4").attr("dy","-5").text(function(d){return d.name}),this.svg.append("line").attr("class","line0").attr("x1",0).attr("x2",this.width).attr("y1",this.y(0)).attr("y2",this.y(0))},this.getSvg=function(){return this.svg},this._init=function(container,conf){this.conf=$.extend(!0,this.conf,this._defaults,conf),this.width=this.conf.width-this.conf.margin.left-this.conf.margin.right,this.height=this.conf.height-this.conf.margin.top-this.conf.margin.bottom,this.x0=d3.scale.ordinal().rangeRoundBands([0,this.width],.2),this.x1=d3.scale.ordinal(),this.y=d3.scale.linear().range([this.height,0]),this.xAxis=d3.svg.axis().scale(this.x0).orient("bottom"),this.yAxis=d3.svg.axis().scale(this.y).orient("left").tickFormat(d3.format(".2s")),this.svg=d3.select(container).append("svg").attr("width",this.width+this.conf.margin.left+this.conf.margin.right).attr("height",this.height+this.conf.margin.top+this.conf.margin.bottom).append("g").attr("transform","translate("+this.conf.margin.left+","+this.conf.margin.top+")"),this.tooltip=d3.select(container).append("div").attr("class","tooltip").style("opacity",0)},this._init(container,conf),data&&this.updateData(data)}}}(window,jQuery,d3),function(context){var _channels=null,_tabId=null,_prefix="polyBC_";function getRandomString(length){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<(length||5);i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text}function getTimestamp(){return(new Date).getTime()}function BroadcastChannel(channelName){if(context.localStorage){var _channelId=_prefix+channelName,isFirstChannel=null===_channels;return this.channelId=_channelId,_tabId=_tabId||getRandomString(),(_channels=_channels||{})[_channelId]=_channels[_channelId]||[],_channels[_channelId].push(this),this.name=_channelId+"::::"+getRandomString()+getTimestamp(),isFirstChannel&&context.addEventListener("storage",_onmsg.bind(this),!1),this}console.error("localStorage not available")}function _onmsg(ev){var key=ev.key,newValue=ev.newValue,isRemoved=!newValue,obj=null;if(key.indexOf("eomBCmessage_")>-1&&!isRemoved){try{obj=JSON.parse(newValue)}catch(ex){return void console.error("Message conversion has resulted in an error.")}if(obj.tabId!==_tabId&&obj.channelId&&_channels&&_channels[obj.channelId]){var subscribers=_channels[obj.channelId];for(var j in subscribers)!subscribers[j].closed&&subscribers[j].onmessage&&subscribers[j].onmessage(obj.message);context.localStorage.removeItem(key)}}}BroadcastChannel.prototype.onmessage=function(ev){},BroadcastChannel.prototype.postMessage=function(data){if(_channels)if(this.closed)console.error("This BroadcastChannel is closed.");else{var msgObj=function(data){return{timestamp:getTimestamp(),isTrusted:!0,target:null,currentTarget:null,data:data,bubbles:!1,cancelable:!1,defaultPrevented:!1,lastEventId:"",origin:context.location.origin}}(data),subscribers=_channels[this.channelId]||[];for(var j in subscribers)subscribers[j].closed||subscribers[j].name===this.name||subscribers[j].onmessage&&subscribers[j].onmessage(msgObj);var editedObj={channelId:this.channelId,bcId:this.name,tabId:_tabId,message:msgObj};try{var editedJSON=JSON.stringify(editedObj),lsKey="eomBCmessage_"+getRandomString()+"_"+this.channelId;context.localStorage.setItem(lsKey,editedJSON)}catch(ex){return void console.error("Message conversion has resulted in an error.")}setTimeout(function(){context.localStorage.removeItem(lsKey)},1e3)}},BroadcastChannel.prototype.close=function(){this.closed=!0;var index=_channels[this.channelId].indexOf(this);index>-1&&_channels[this.channelId].splice(index,1),_channels[this.channelId].length||delete _channels[this.channelId],function(obj){for(var prop in obj)if(obj.hasOwnProperty(prop))return!1;return!0}(_channels)&&context.removeEventListener("storage",_onmsg.bind(this))},context.BroadcastChannel=context.BroadcastChannel||BroadcastChannel}(window.top),function(window,$,undefined){var elca=window.elca=window.elca||{};elca.msgBus=elca.msgBus=elca.msgBus||new function(){var self=this;this.broadcastChannel=new BroadcastChannel("msg-bus"),this.handlers={},this.registerHandler=function(eventType,handler){console.debug("Register a new event handler for "+eventType),void 0===this.handlers[eventType]&&(this.handlers[eventType]=[]),this.handlers[eventType].push(handler)},this.submit=function(eventType,data){console.debug("Submit a new event of type ["+eventType+"]",data),data.event=eventType,this.broadcastChannel.postMessage(data)},this.broadcastChannel.onmessage=function(event){console.debug("Event ["+(event.data.event||"<unknown>")+"] received ",event.data);var data=event.data;if(data.event){var eventType=data.event,handlers=self.handlers[eventType]||[];console.debug("Found "+handlers.length+" handler for this event"),handlers.forEach(function(handler){handler(data)})}else console.error("Message without event type",event)},console.debug("eLCA msgBus initialized")}}(window,jQuery);